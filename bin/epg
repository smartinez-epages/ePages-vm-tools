#!/bin/bash
VERSION=1.4

SCRIPT=$0
NAME=$( basename ${SCRIPT} )
WRK_DIR=$( dirname ${SCRIPT} )
TMP_DIR=/tmp/${NAME}.$(date +'%Y%m%d%H%M%S')

REPO_VER=https://github.com/smartinez-epages/ePages-vm-tools/raw/master/version.txt
REPO_ALL=https://github.com/smartinez-epages/ePages-vm-tools/archive/master.zip

UPDATE_VER=version.txt
UPDATE_PKG=update.zip
UPDATE_BIN=${TMP_DIR}/ePages-vm-tools-master/bin

BACKUP_FILENAME=backup.tgz

VERBOSE=1
BATCHMODE=0

#======================================================================================================================
# main
#======================================================================================================================
function main() {
  [ $# -eq 0 ] && showHelp

  ACTION=$1
  shift

  case "${ACTION}" in

    update)
      update
      ;;

    one)
      run one $*
      ;;

    two)
      run two $*
      ;;

    *)
     showHelp
  esac

  exit 0

}

#======================================================================================================================
# log
#======================================================================================================================
function log() {
  [ $VERBOSE -ne 0 ] echo "$*"
}

#======================================================================================================================
# showHelp
#======================================================================================================================
function showHelp() {
  DATA_SEGMENT=$( grep -n '^<<< DATA >>>$' ${SCRIPT} | cut -d : -f 1 )
  DATA_SEGMENT=$((${DATA_SEGMENT}+1))
  tail -n +$DATA_SEGMENT ${SCRIPT} |
    sed -r -e "s/@@NAME@@/${NAME}/g" -e "s/@@VERSION@@/${VERSION}/g"

  exit 1
}

#======================================================================================================================
# update
#======================================================================================================================
function update() {
  updateBegin
  updateCheckNewVersion
  if [ $? -eq 1 ]
  then
    updateDownloadPackage
    updatePreparePackage
    updateOverwrite
  fi
  updateClean
}

#======================================================================================================================
# updateBegin
#======================================================================================================================
function updateBegin() {
  [ -d ${TMP_DIR} ] && rm -rf ${TMP_DIR}
  mkdir ${TMP_DIR}
}

#======================================================================================================================
# updateCheckNewVersion
#======================================================================================================================
function updateCheckNewVersion() {
  LAST_VERSION_FILE=${TMP_DIR}/${UPDATE_VER}

  log "Checking for new versions ..."
  wget -q -O ${LAST_VERSION_FILE} ${REPO_VER}
  if [ $? -eq 0 ]
  then
    LAST_VERSION=$( cat ${LAST_VERSION_FILE} )
    UPDATE=$( echo ${LAST_VERSION} | awk -v VERSION=${VERSION} '$1 > VERSION { print "YES" }' )
    if [ "${UPDATE}" == "YES" ]
    then
      log "New version ${LAST_VERSION} released !!!"
      [ ${BATCHMODE} -eq 1 ] return 1
      read -p "Do you want to update [y/n] ? " UPDATE
      [ "${UPDATE}" == "y" ] && return 1
    fi
  fi

  return 0
}

#======================================================================================================================
# updateDownloadPackage
#======================================================================================================================
function updateDownloadPackage() {
  PACKAGE=${TMP_DIR}/${UPDATE_PKG}

  log "Downloading new version..."
  wget -q -O ${PACKAGE} ${REPO_ALL}
  if [ $? -eq 0 ]
  then
    log "Unpacking new version..."
    unzip -q -d ${TMP_DIR} ${PACKAGE}
  fi
}
    
#======================================================================================================================
# updatePreparePackage
#======================================================================================================================
function updatePreparePackage() {
  [ -d ${UPDATE_BIN} ] && find ${UPDATE_BIN} -type f -exec chmod 755 {} \;
}

#======================================================================================================================
# updateOverwrite
#======================================================================================================================
function updateOverwrite() {
  if [ ${UPDATE_BIN} ]
  then
    log "Creating backup of current version in ${BACKUP_FILENAME}"
    tar -C ${WRK_DIR} --exclude=${BACKUP_FILENAME} -czf ${UPDATE_BIN}/${BACKUP_FILENAME} .
    log "Overwriting with new version"
    rm -rf ${WRK_DIR}/
    mv ${UPDATE_BIN}/* ${WRK_DIR}/
  fi
}

#======================================================================================================================
# updateClean
#======================================================================================================================
function updateClean() {
  log "Cleaning up"
  echo rm -rf ${TMP_DIR}
}

#======================================================================================================================
# 
#======================================================================================================================
function run() {
  SCRIPT=$1
  shift

  echo eval ${SCRIPT} $*
}

#======================================================================================================================
# Script execution starting point !!!
#======================================================================================================================
main $*

<<< DATA >>>

@@NAME@@ @@VERSION@@ : ePages-vm scripts launcher 

Usage: @@NAME@@ ACTION

  Embedded actions:

    update    Checks for new @@NAME@@ version

    list      List of available vm-scripts

 <<TODO>>

